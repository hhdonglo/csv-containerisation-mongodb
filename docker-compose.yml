# Healthcare Data Processing Pipeline - Docker Compose
# MongoDB database, migration service, and web UI
# Author: hhdonglo - OpenClassrooms (DataSoluTech)


# establish services and configurations
services:
  mongodb:
    image: mongo:8.2
    container_name: healthcare_mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-dev_user}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-dev_user_pass}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-medical_records}
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
      - ./data/raw:/data/raw:ro
      - ./data/processed:/data/processed
    networks:
      - healthcare_network
    restart: unless-stopped 
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


 # Data migration application service
  migration_app:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    container_name: healthcare_migration
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./data:/app/data
    environment:
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_USERNAME: ${MONGO_USERNAME:-dev_user}
      MONGO_PASSWORD: ${MONGO_PASSWORD:-dev_user_pass}
      MONGO_DATABASE: ${MONGO_DATABASE:-medical_records}
      MONGO_URI: mongodb://${MONGO_USERNAME:-dev_user}:${MONGO_PASSWORD:-dev_user_pass}@mongodb:27017/${MONGO_DATABASE:-medical_records}?authSource=admin
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
    networks:
      - healthcare_network
    restart: "no"


  # Mongo Express web UI for MongoDB
  mongo_express:
    image: mongo-express:1.0-20
    container_name: healthcare_mongo_ui
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_USERNAME:-dev_user}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASSWORD:-dev_user_pass}
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_USERNAME:-dev_user}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_PASSWORD:-dev_user_pass}
    networks:
      - healthcare_network
    restart: unless-stopped

# define volumes and networks
volumes:
  mongo_data:
    driver: local
networks:
  healthcare_network:
    driver: bridge